---------------------------------Headline------------------------------
--
-- System/Module: ENABLERDB
--
-- Name:  DDL_TASK_MANAGER_DATA_MODEL.sql
--
-- Created by              Adnane AMELLAL
-- Creation date           16/02/2025
-- Version
--
-- -- Tables impacted:
--
-- Description:
--
-- Parameters     IN:
-- Parameters    OUT:
-- Parameters IN-OUT:
--
-- Return values:
-- Error codes:
--
--------------------------------Barcode--------------------------------

-- Schema TASKMANAGER

CREATE USER TASKMANAGER IDENTIFIED BY TASKMANAGER DEFAULT TABLESPACE DATA TEMPORARY TABLESPACE TEMP;
GRANT CONNECT TO TASKMANAGER;  
GRANT RESOURCE TO TASKMANAGER;
ALTER USER TASKMANAGER QUOTA UNLIMITED ON DATA;
ALTER USER TASKMANAGER QUOTA UNLIMITED ON INDX;

-- Table TSK_SCHEMA_REGISTRY
CREATE TABLE TASKMANAGER.TSK_SCHEMA_REGISTRY
(
  ID           NUMBER GENERATED BY DEFAULT AS IDENTITY ( START WITH 61 MAXVALUE 9999999999999999999999999999 MINVALUE 1 NOCYCLE CACHE 20 NOORDER NOKEEP NOSCALE) NOT NULL,
  NAME         VARCHAR2(255),
  DESCRIPTION  VARCHAR2(255),
  "SCHEMA"     CLOB
)/*
LOB ("SCHEMA") STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOLOGGING
NOCOMPRESS
NOCACHE*/;
 
ALTER TABLE TASKMANAGER.TSK_SCHEMA_REGISTRY ADD CONSTRAINT PK_TSK_SCHEMA_REGISTRY_ID PRIMARY KEY  (ID);
 
CREATE OR REPLACE PUBLIC SYNONYM TSK_SCHEMA_REGISTRY FOR TASKMANAGER.TSK_SCHEMA_REGISTRY;


-- Table TSK_TASK_TYPE

CREATE TABLE TASKMANAGER.TSK_TASK_TYPE
(
    ID   NUMBER
    GENERATED ALWAYS AS IDENTITY
(
                   START WITH 61
    MAXVALUE 9999999999999999999999999999
    MINVALUE 1
    NOCYCLE
    CACHE 20
    NOORDER
    NOKEEP
    NOSCALE
    )
                                 NOT NULL,
    TSK_SCHEMA_REGISTRY_ID    NUMBER,
    WORKFLOW_BUSINESS_KEY     VARCHAR2 (100),
    PROCESS_BUSINESS_KEY      VARCHAR2 (100),
    TASK_DESCRIPTION          VARCHAR2 (250),
    BUCKET_NAME               VARCHAR2 (150),
    SCHEDULE                  VARCHAR2 (150),
    AUTH_CONFIG               CLOB,
    QUERY                     VARCHAR2 (500),
    MAX_LINES                 INTEGER,
    NEEDS_SPLITTING           INTEGER,
    NEEDS_DECOMPOSITION       INTEGER,
    PROCESSING_TYPE           VARCHAR2 (50),
    MAX_COUNT_PER_CHUNK       INTEGER,
    FORM_CONFIG               CLOB,
    INPUT_PATH                VARCHAR2 (500),
    NEEDS_PREVALIDATION       INTEGER,
    INPUT_TYPE                VARCHAR2 (50),
    SHORT_DESCRIPTION         VARCHAR2 (20),
    DELIMITER                 VARCHAR2 (20),
    DISPLAYED                 INTEGER
)/*
LOB (AUTH_CONFIG) STORE AS SECUREFILE
    (TABLESPACE DATA
     ENABLE STORAGE IN ROW
     CHUNK 8192
     NOCACHE LOGGING
     STORAGE (INITIAL 104 K
              NEXT 1 M
              MINEXTENTS 1
              MAXEXTENTS UNLIMITED
              PCTINCREASE 0
              BUFFER_POOL DEFAULT))
LOB (FORM_CONFIG) STORE AS SECUREFILE
    (TABLESPACE DATA
     ENABLE STORAGE IN ROW
     CHUNK 8192
     NOCACHE LOGGING
     STORAGE (INITIAL 104 K
              NEXT 1 M
              MINEXTENTS 1
              MAXEXTENTS UNLIMITED
              PCTINCREASE 0
              BUFFER_POOL DEFAULT))
TABLESPACE DATA
PCTUSED 0
PCTFREE 10
INITRANS 1
MAXTRANS 255
STORAGE (INITIAL 64 K
         NEXT 1 M
         MINEXTENTS 1
         MAXEXTENTS UNLIMITED
         PCTINCREASE 0
         BUFFER_POOL DEFAULT)
NOLOGGING
NOCOMPRESS
NOCACHE*/;


-- Table TSK_TASK_TYPE_UNIQUE

CREATE UNIQUE INDEX TASKMANAGER.TSK_TASK_TYPE_UNIQUE
    ON TASKMANAGER.TSK_TASK_TYPE (SHORT_DESCRIPTION)
    LOGGING
    TABLESPACE INDX
    PCTFREE 10
    INITRANS 2
    MAXTRANS 255
    STORAGE (INITIAL 64 K
             NEXT 1 M
             MINEXTENTS 1
             MAXEXTENTS UNLIMITED
             PCTINCREASE 0
             BUFFER_POOL DEFAULT);
             
ALTER TABLE TASKMANAGER.TSK_TASK_TYPE ADD CONSTRAINT PK_TSK_TASK_TYPE_ID PRIMARY KEY  (ID);             
ALTER TABLE TASKMANAGER.TSK_TASK_TYPE
    ADD (CONSTRAINT TSK_TASK_TYPE_UNIQUE UNIQUE (SHORT_DESCRIPTION)
            USING INDEX TASKMANAGER.TSK_TASK_TYPE_UNIQUE ENABLE VALIDATE);
 
CREATE OR REPLACE PUBLIC SYNONYM TSK_TASK_TYPE FOR TASKMANAGER.TSK_TASK_TYPE;
 
ALTER TABLE TASKMANAGER.TSK_TASK_TYPE
    ADD (
        CONSTRAINT FK_TSK_SCHEMA_REGISTRY FOREIGN KEY
            (TSK_SCHEMA_REGISTRY_ID)
            REFERENCES TASKMANAGER.TSK_SCHEMA_REGISTRY (ID)
            ENABLE VALIDATE);

-- Table TSK_TASK

CREATE TABLE TASKMANAGER.TSK_TASK
(
    ID               NUMBER
                        GENERATED ALWAYS AS IDENTITY
(
          START WITH 1
    MAXVALUE 9999999999999999999999999999
    MINVALUE 1
    NOCYCLE
    CACHE 20
    NOORDER
    NOKEEP
    NOSCALE
    )
                      NOT NULL,
    TASK_TYPE_ID      NUMBER,
    STATUS            VARCHAR2 (30),
    SCHEDULE_DATE     TIMESTAMP(6),
    MODIFICATION_DATE DATE,
    CREATED_BY        VARCHAR2 (30),
    PAYLOAD           CLOB,
    FORM_INPUT        CLOB,
    URL               CLOB,
    TASK_CONTEXT      CLOB
)/*
LOB (FORM_INPUT) STORE AS SECUREFILE
    (TABLESPACE DATA
     ENABLE STORAGE IN ROW
     CHUNK 8192
     NOCACHE LOGGING
     STORAGE (INITIAL 104 K
              NEXT 1 M
              MINEXTENTS 1
              MAXEXTENTS UNLIMITED
              PCTINCREASE 0
              BUFFER_POOL DEFAULT))
LOB (PAYLOAD) STORE AS SECUREFILE
    (TABLESPACE DATA
     ENABLE STORAGE IN ROW
     CHUNK 8192
     NOCACHE LOGGING
     STORAGE (INITIAL 104 K
              NEXT 1 M
              MINEXTENTS 1
              MAXEXTENTS UNLIMITED
              PCTINCREASE 0
              BUFFER_POOL DEFAULT))
LOB (TASK_CONTEXT) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))              
LOB (URL) STORE AS SECUREFILE
    (TABLESPACE DATA
     ENABLE STORAGE IN ROW
     CHUNK 8192
     NOCACHE LOGGING
     STORAGE (INITIAL 104 K
              NEXT 1 M
              MINEXTENTS 1
              MAXEXTENTS UNLIMITED
              PCTINCREASE 0
              BUFFER_POOL DEFAULT))
TABLESPACE DATA
PCTUSED 0
PCTFREE 10
INITRANS 1
MAXTRANS 255
STORAGE (INITIAL 64 K
         NEXT 1 M
         MINEXTENTS 1
         MAXEXTENTS UNLIMITED
         PCTINCREASE 0
         BUFFER_POOL DEFAULT)
NOLOGGING
NOCOMPRESS
NOCACHE*/;
 
ALTER TABLE TASKMANAGER.TSK_TASK ADD CONSTRAINT PK_TSK_TASK_ID PRIMARY KEY  (ID);
 
CREATE OR REPLACE PUBLIC SYNONYM TSK_TASK FOR TASKMANAGER.TSK_TASK;
            
ALTER TABLE TASKMANAGER.TSK_TASK
    ADD (
        FOREIGN KEY
            (TASK_TYPE_ID)
            REFERENCES TASKMANAGER.TSK_TASK_TYPE (ID)
            ENABLE VALIDATE);

-- Table TSK_CHUNKTOTASK

CREATE TABLE TASKMANAGER.TSK_CHUNKTOTASK
(
  ID        NUMBER GENERATED BY DEFAULT AS IDENTITY ( START WITH 1 MAXVALUE 9999999999999999999999999999 MINVALUE 1 NOCYCLE CACHE 20 NOORDER NOKEEP NOSCALE) NOT NULL,
  TASK_ID   NUMBER                              NOT NULL,
  CHUNK_ID  NUMBER                              NOT NULL
)/*
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOLOGGING 
NOCOMPRESS 
NOCACHE*/;
 
ALTER TABLE TASKMANAGER.TSK_CHUNKTOTASK ADD CONSTRAINT PK_TSK_CHUNKTOTASK_ID PRIMARY KEY  (ID); 

CREATE OR REPLACE PUBLIC SYNONYM TSK_CHUNKTOTASK FOR TASKMANAGER.TSK_CHUNKTOTASK;

-- Table TSK_RAW_RECORD

CREATE TABLE TASKMANAGER.TSK_RAW_RECORD
(
  ID               NUMBER GENERATED ALWAYS AS IDENTITY ( START WITH 1 MAXVALUE 9999999999999999999999999999 MINVALUE 1 NOCYCLE CACHE 20 NOORDER NOKEEP NOSCALE) NOT NULL,
  CHUNK_ID         NUMBER,
  PARENT_ID        NUMBER,
  PARSED_RECORD    CLOB,
  RAW_JSON         CLOB,
  RAW_READ         VARCHAR2(255),
  STATUS           VARCHAR2(30),
  TASK_ID          NUMBER,
  TO_BE_PROCESSED  INTEGER
)/*
LOB (PARSED_RECORD) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
LOB (RAW_JSON) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCOMPRESS 
NOCACHE*/;

ALTER TABLE TASKMANAGER.TSK_RAW_RECORD ADD CONSTRAINT PK_TSK_RAW_RECORD_ID PRIMARY KEY (ID); 
ALTER TABLE TASKMANAGER.TSK_RAW_RECORD ADD (
  CHECK (TO_BE_PROCESSED IN (0,1))
  ENABLE VALIDATE);
  
CREATE OR REPLACE PUBLIC SYNONYM TSK_RAW_RECORD FOR TASKMANAGER.TSK_RAW_RECORD;

-- Table TSK_TASK_OUTPUT

CREATE TABLE TASKMANAGER.TSK_TASK_OUTPUT
(
  ID              NUMBER GENERATED ALWAYS AS IDENTITY ( START WITH 1 MAXVALUE 9999999999999999999999999999 MINVALUE 1 NOCYCLE CACHE 20 NOORDER NOKEEP NOSCALE) NOT NULL,
  TASK_ID     NUMBER,
  OUTPUT_TYPE     VARCHAR2(100),
  URLS            CLOB,
  OUTPUT_SUMMARY  CLOB
)/*
LOB (OUTPUT_SUMMARY) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING)
LOB (URLS) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING)
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOLOGGING 
NOCOMPRESS 
NOCACHE*/;
 
ALTER TABLE TASKMANAGER.TSK_TASK_OUTPUT ADD CONSTRAINT PK_TSK_TASK_OUTPUT_ID PRIMARY KEY (ID); 

CREATE INDEX TASKMANAGER.IDX_OUTPUT_TSK_TASK_ID ON TASKMANAGER.TSK_TASK_OUTPUT
(TSK_TASK_ID)
NOLOGGING
TABLESPACE INDX
PCTFREE    10
INITRANS   2
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           );
 
ALTER TABLE TASKMANAGER.TSK_TASK_OUTPUT ADD (
  FOREIGN KEY (TSK_TASK_ID) 
  REFERENCES TASKMANAGER.TSK_TASK (ID)
  ENABLE VALIDATE);
 
CREATE OR REPLACE PUBLIC SYNONYM TSK_TASK_OUTPUT FOR TASKMANAGER.TSK_TASK_OUTPUT;


-- Table TSK_REASON


CREATE TABLE TASKMANAGER.TSK_REASON
(
  CODE              VARCHAR2(20),
  DESCRIPTION       VARCHAR2(150)
)/*
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             16M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCACHE*/;

ALTER TABLE TASKMANAGER.TSK_REASON ADD CONSTRAINT PK_TSK_REASON_CODE PRIMARY KEY (CODE); 

CREATE OR REPLACE PUBLIC SYNONYM TSK_REASON FOR TASKMANAGER.TSK_REASON;

-- table TSK_STATUS

CREATE TABLE TASKMANAGER.TSK_STATUS
(
  CODE              VARCHAR2(20),
  DESCRIPTION       VARCHAR2(150)
)
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             16M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
LOGGING 
NOCACHE;

ALTER TABLE TASKMANAGER.TSK_STATUS ADD CONSTRAINT PK_TSK_STATUS_CODE PRIMARY KEY (CODE); 

CREATE OR REPLACE PUBLIC SYNONYM TSK_STATUS FOR TASKMANAGER.TSK_STATUS;

-- table TSK_STATUS

CREATE TABLE TASKMANAGER.TSK_PROCESSED_RECORD
(
  ID              NUMBER  NOT NULL,
  TASK_ID         NUMBER  NOT NULL,
  CHUNK_ID        INTEGER,
  RAW_LINE        VARCHAR2(500),
  REASON          VARCHAR2(20),
  STATUS          VARCHAR2(20),
  RAW_JSON        CLOB,
  PARSED_RECORD   CLOB,
  OUTPUT_RECORD   CLOB,
  STATUS_HISTORY  CLOB
)/*
LOB (OUTPUT_RECORD) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
LOB (PARSED_RECORD) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
LOB (RAW_JSON) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
LOB (STATUS_HISTORY) STORE AS SECUREFILE (
  TABLESPACE  DATA
  ENABLE      STORAGE IN ROW
  CHUNK       8192
  NOCACHE
  LOGGING
      STORAGE    (
                  INITIAL          104K
                  NEXT             1M
                  MINEXTENTS       1
                  MAXEXTENTS       UNLIMITED
                  PCTINCREASE      0
                  BUFFER_POOL      DEFAULT
                 ))
TABLESPACE DATA
PCTUSED    0
PCTFREE    10
INITRANS   1
MAXTRANS   255
STORAGE    (
            INITIAL          64K
            NEXT             1M
            MINEXTENTS       1
            MAXEXTENTS       UNLIMITED
            PCTINCREASE      0
            BUFFER_POOL      DEFAULT
           )
NOLOGGING 
NOCOMPRESS 
NOCACHE*/;

CREATE OR REPLACE PUBLIC SYNONYM TSK_PROCESSED_RECORD FOR TASKMANAGER.TSK_PROCESSED_RECORD;

ALTER TABLE TASKMANAGER.TSK_PROCESSED_RECORD ADD (
  FOREIGN KEY (TASK_ID) 
  REFERENCES TASKMANAGER.TSK_TASK (ID)
  ENABLE VALIDATE);
  
ALTER TABLE TASKMANAGER.TSK_PROCESSED_RECORD ADD (
  FOREIGN KEY (REASON) 
  REFERENCES TASKMANAGER.TSK_REASON (CODE)
  ENABLE VALIDATE);
  
ALTER TABLE TASKMANAGER.TSK_PROCESSED_RECORD ADD (
  FOREIGN KEY (STATUS) 
  REFERENCES TASKMANAGER.TSK_STATUS (CODE)
  ENABLE VALIDATE);


-- grant

GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_SCHEMA_REGISTRY TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_TASK_TYPE TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_TASK TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_CHUNKTOTASK TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_RAW_RECORD TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_TASK_OUTPUT TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_REASON TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_STATUS TO LIQUI_DML_ROLE; 
GRANT SELECT, UPDATE, DELETE, INSERT ON TASKMANAGER.TSK_PROCESSED_RECORD TO LIQUI_DML_ROLE; 